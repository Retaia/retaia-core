services:
  core:
    image: ${RETAIA_CORE_IMAGE:-ghcr.io/retaia/retaia-core:v1.0.0}
    container_name: retaia-core-core
    restart: unless-stopped
    environment:
      APP_ENV: prod
      APP_DEBUG: "0"
      DATABASE_URL: ${DATABASE_URL:-postgresql://app:app@db:5432/app_prod?serverVersion=16&charset=utf8}
      APP_INGEST_WATCH_PATH: /var/local/RETAIA/INBOX
      DEFAULT_URI: ${DEFAULT_URI:-http://localhost:${RETAIA_PROD_HTTP_PORT:-8080}}
      APP_SECRET: ${APP_SECRET:-change-me}
      SYMFONY_TRUSTED_PROXIES: ${SYMFONY_TRUSTED_PROXIES:-127.0.0.1/32}
      APP_STORAGE_ID: ${APP_STORAGE_ID:-nas-main}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - retaia_var:/var/www/html/var
      - ${RETAIA_INGEST_HOST_DIR:-./docker/RETAIA}:/var/local/RETAIA

  ingest-cron:
    image: ${RETAIA_CORE_IMAGE:-ghcr.io/retaia/retaia-core:v1.0.0}
    container_name: retaia-core-ingest-cron
    restart: unless-stopped
    environment:
      APP_ENV: prod
      APP_DEBUG: "0"
      DATABASE_URL: ${DATABASE_URL:-postgresql://app:app@db:5432/app_prod?serverVersion=16&charset=utf8}
      APP_INGEST_WATCH_PATH: /var/local/RETAIA/INBOX
      DEFAULT_URI: ${DEFAULT_URI:-http://localhost:${RETAIA_PROD_HTTP_PORT:-8080}}
      APP_STORAGE_ID: ${APP_STORAGE_ID:-nas-main}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - retaia_var:/var/www/html/var
      - ${RETAIA_INGEST_HOST_DIR:-./docker/RETAIA}:/var/local/RETAIA
    command:
      - /bin/sh
      - -lc
      - |
        while true; do
          php bin/console app:ingest:cron-tick --no-interaction --poll-limit=100 --enqueue-limit=100 --apply-limit=200 || true
          sleep 60
        done

  ui:
    image: ${RETAIA_UI_IMAGE:-ghcr.io/retaia/retaia-ui:v1.0.0}
    container_name: retaia-core-ui
    restart: unless-stopped
    environment:
      API_BASE_URL: ${RETAIA_UI_API_BASE_URL:-/api/v1}
      API_UPSTREAM: ${RETAIA_UI_API_UPSTREAM:-core:9000}
    depends_on:
      core:
        condition: service_started

  caddy:
    image: caddy:2-alpine
    container_name: retaia-core-caddy
    restart: unless-stopped
    depends_on:
      core:
        condition: service_started
      ui:
        condition: service_started
    ports:
      - "${RETAIA_PROD_HTTP_PORT:-8080}:80"
    volumes:
      - ./docker/Caddyfile.prod.example:/etc/caddy/Caddyfile:ro
      - ./public:/var/www/html/public:ro

  db:
    image: postgres:16-alpine
    container_name: retaia-core-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-app_prod}
      POSTGRES_USER: ${POSTGRES_USER:-app}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app}
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD", "pg_isready", "-d", "${POSTGRES_DB:-app_prod}", "-U", "${POSTGRES_USER:-app}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    volumes:
      - retaia_db_prod:/var/lib/postgresql/data

volumes:
  retaia_var:
  retaia_db_prod:
